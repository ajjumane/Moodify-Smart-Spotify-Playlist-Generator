<!DOCTYPE html>
<html>
<head>
    <title>Moodify Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
</head>

<body class="player-page theme-{{ language|lower }} mood-{{ mood|lower }}">

<div class="top-bar player-top">
    <div class="app-name">MOODIFY</div>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
</div>

{% if session.spotify_user %}
    <div class="user-info">
        {% if session.spotify_user.images %}
            <img src="{{ session.spotify_user.images[0].url }}" class="profile-pic">
        {% endif %}
        <span>{{ session.spotify_user.display_name }}</span>
    </div>
{% endif %}

<div class="main-container">

    {% if error %}
        <div class="error-card">
            <h3>Something went wrong</h3>
            <p>{{ error }}</p>
            <a href="{{ url_for('mood') }}" class="secondary-link">
                ‚Üê Try Again
            </a>
        </div>
    {% else %}

    <div class="top-section">

        <div class="selection-info">
            <h2 class="selection-text">
                {{ selected_language|title }} ‚Ä¢ {{ selected_mood|title }}
            </h2>
            <a href="{{ url_for('mood') }}" class="secondary-link">
                Change Selection
            </a>
        </div>

        <div class="player-section">

            <div class="player-card">

                <p class="now-label">Now Playing</p>

                <img id="album-art" class="big-album-art" src="">

                <div class="track-info">
                    <h3 id="track-name">Loading...</h3>
                    <p id="artist-name"></p>
                </div>

                <div class="player-controls">
                    <button onclick="previous()" class="circle-btn">‚èÆ</button>
                    <button onclick="togglePlay()" class="circle-btn play-btn">‚ñ∂</button>
                    <button onclick="next()" class="circle-btn">‚è≠</button>
                </div>

                <div class="progress-wrapper">
                    <span id="current-time">0:00</span>

                    <input type="range"
                           id="progress-slider"
                           min="0"
                           max="100"
                           value="0"
                           step="1">

                    <span id="total-time">0:00</span>
                </div>

                <div class="volume-container">
                    <span class="volume-icon">
                        üîä
                    </span>
                    <input type="range"
                           min="0"
                           max="1"
                           step="0.01"
                           value="0.8"
                           oninput="setVolume(this.value)"
                           class="volume-slider">
                </div>

            </div>
        </div>
    </div>

    <div class="bottom-section">
        <h3 class="section-title">Suggested Playlists</h3>

        <div class="suggestion-list">
            {% for playlist in suggestions %}
                <div class="playlist-card">
                    <iframe 
                        src="https://open.spotify.com/embed/playlist/{{ playlist.id }}"
                        allow="encrypted-media">
                    </iframe>
                </div>
            {% endfor %}
        </div>
    </div>

    {% endif %}

</div>

<script>
const token = "{{ session['access_token'] if session.get('access_token') else '' }}";
{% if main_playlist %}
const playlistUri = "spotify:playlist:{{ main_playlist.id }}";
{% endif %}

let player;
let deviceId;
let isPlaying = false;
let durationMs = 0;

const progressSlider = document.getElementById("progress-slider");
const currentTimeEl = document.getElementById("current-time");
const totalTimeEl = document.getElementById("total-time");

function formatTime(ms) {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
}

{% if not error and main_playlist %}

window.onSpotifyWebPlaybackSDKReady = () => {

    player = new Spotify.Player({
        name: 'Moodify Web Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.8
    });

    player.addListener('ready', async ({ device_id }) => {
        deviceId = device_id;

        await fetch(
            'https://api.spotify.com/v1/me/player/play?device_id=' + deviceId,
            {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    context_uri: playlistUri,
                    offset: { position: 0 },
                    position_ms: 0
                })
            }
        );
    });

    player.addListener('player_state_changed', state => {
        if (!state) return;

        const current = state.track_window.current_track;

        document.getElementById('track-name').innerText = current.name;
        document.getElementById('artist-name').innerText =
            current.artists.map(a => a.name).join(', ');

        document.getElementById('album-art').src =
            current.album.images[0].url;

        durationMs = state.duration;

        totalTimeEl.innerText = formatTime(durationMs);
        currentTimeEl.innerText = formatTime(state.position);
        progressSlider.value = (state.position / durationMs) * 100;

        isPlaying = !state.paused;
        document.querySelector('.play-btn').innerText =
            isPlaying ? '‚è∏' : '‚ñ∂';
    });

    player.connect();
};

progressSlider?.addEventListener("input", async function () {
    const seekPosition = (this.value / 100) * durationMs;
    await player.seek(seekPosition);
});

function togglePlay() {
    player.togglePlay();
}

function next() {
    fetch(
        'https://api.spotify.com/v1/me/player/next?device_id=' + deviceId,
        {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        }
    );
}

function previous() {
    fetch(
        'https://api.spotify.com/v1/me/player/previous?device_id=' + deviceId,
        {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        }
    );
}

function setVolume(value) {
    player.setVolume(parseFloat(value));
}

{% endif %}
</script>

</body>
</html>
