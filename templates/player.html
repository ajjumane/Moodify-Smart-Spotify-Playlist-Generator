<!DOCTYPE html>
<html>
<head>
    <title>MOODIFY Player</title>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body class="player-page theme-{{ language|lower }} mood-{{ mood|lower }}">

<div class="main-container">

    <div class="top-section">

        <div class="selection-info">
            <h2 class="selection-text">
                {{ selected_language|title }} • {{ selected_mood|title }}
            </h2>
            <button onclick="window.history.back()" class="change-btn">
                Change Selection
            </button>
        </div>

        <div class="player-section">

            <div class="player-card">

                <p class="now-label">Currently Playing</p>

                <img id="album-art" class="big-album-art" src="">

                <div class="track-info">
                    <h3 id="track-name">Loading...</h3>
                    <p id="artist-name"></p>
                </div>

                <div class="player-controls">
                    <button onclick="previous()" class="circle-btn">⏮</button>
                    <button onclick="togglePlay()" class="circle-btn play-btn">▶</button>
                    <button onclick="next()" class="circle-btn">⏭</button>
                </div>

                <!-- NEW PROGRESS SECTION -->
                <div class="progress-wrapper">
                    <span id="current-time">0:00</span>

                    <input type="range"
                           id="progress-slider"
                           min="0"
                           max="100"
                           value="0"
                           step="1">

                    <span id="total-time">0:00</span>
                </div>

                <div class="volume-container">
                <span class="volume-icon">
                    <svg viewBox="0 0 24 24" width="25" height="25" fill="currentColor">
                        <path d="M3 9v6h4l5 5V4L7 9H3z"/>
                        <path d="M14.5 12c0-1.77-1-3.29-2.5-4.03v8.05c1.5-.73 2.5-2.25 2.5-4.02z"/>
                    </svg>
                </span>
                    <input type="range"
                           min="0"
                           max="1"
                           step="0.01"
                           value="0.8"
                           oninput="setVolume(this.value)"
                           class="volume-slider">
                </div>

            </div>
        </div>
    </div>

    <div class="bottom-section">

    <h3 class="section-title">Suggested Playlists</h3>

    <div class="suggestion-list">
    {% for playlist in suggestions %}
        <div class="playlist-card {% if playlist.id == main_playlist.id %}active-playlist{% endif %}">
            <iframe 
                src="https://open.spotify.com/embed/playlist/{{ playlist.id }}"
                allow="encrypted-media">
            </iframe>
        </div>
    {% endfor %}
    </div>

</div>


</div>

<script>

const token = "{{ session['access_token'] }}";
const playlistUri = "spotify:playlist:{{ main_playlist.id }}";

let player;
let deviceId;
let isPlaying = false;
let durationMs = 0;
let positionMs = 0;

const progressSlider = document.getElementById("progress-slider");
const currentTimeEl = document.getElementById("current-time");
const totalTimeEl = document.getElementById("total-time");

function formatTime(ms) {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
}

window.onSpotifyWebPlaybackSDKReady = () => {

    player = new Spotify.Player({
        name: 'MOODIFY Web Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.8
    });

    player.addListener('ready', async ({ device_id }) => {
        deviceId = device_id;

        await fetch('https://api.spotify.com/v1/me/player', {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                device_ids: [deviceId],
                play: false
            })
        });

        await fetch(
            'https://api.spotify.com/v1/me/player/play?device_id=' + deviceId,
            {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    context_uri: playlistUri,
                    offset: { position: 0 },
                    position_ms: 0
                })
            }
        );
    });

    player.addListener('player_state_changed', state => {
        if (!state) return;

        const current = state.track_window.current_track;

        document.getElementById('track-name').innerText = current.name;
        document.getElementById('artist-name').innerText =
            current.artists.map(a => a.name).join(', ');

        document.getElementById('album-art').src =
            current.album.images[0].url;

        durationMs = state.duration;
        positionMs = state.position;

        totalTimeEl.innerText = formatTime(durationMs);
        currentTimeEl.innerText = formatTime(positionMs);

        progressSlider.value = (positionMs / durationMs) * 100;

        isPlaying = !state.paused;
        document.querySelector('.play-btn').innerText =
            isPlaying ? '⏸' : '▶';
    });

    // Real-time progress updater
    setInterval(async () => {
        const state = await player.getCurrentState();
        if (!state) return;

        durationMs = state.duration;
        positionMs = state.position;

        currentTimeEl.innerText = formatTime(positionMs);
        progressSlider.value = (positionMs / durationMs) * 100;
    }, 1000);

    player.connect();
};

progressSlider.addEventListener("input", async function () {
    const seekPosition = (this.value / 100) * durationMs;
    await player.seek(seekPosition);
});

function togglePlay() {
    player.togglePlay();
}

function next() {
    fetch(
        'https://api.spotify.com/v1/me/player/next?device_id=' + deviceId,
        {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        }
    );
}

function previous() {
    fetch(
        'https://api.spotify.com/v1/me/player/previous?device_id=' + deviceId,
        {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        }
    );
}

function setVolume(value) {
    player.setVolume(parseFloat(value));
}

</script>

</body>
</html>
